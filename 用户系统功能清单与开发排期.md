# 用户系统功能清单与开发排期

> 项目名称：简历点睛 (ai-resume)
> 文档生成时间：2026年2月6日
> 设计原则：支持匿名使用 + 渐进式登录

---

## 📋 目录

1. [设计原则与架构](#设计原则与架构)
2. [用户系统功能清单](#用户系统功能清单)
3. [技术实现方案](#技术实现方案)
4. [数据库设计](#数据库设计)
5. [开发排期计划](#开发排期计划)
6. [关键注意事项](#关键注意事项)

---

## 设计原则与架构

### 核心原则

**"用完即走，需要时再登录"**

用户可以匿名使用核心功能，登录是为了解锁高级功能（云端历史记录、跨设备同步等）。

---

### 功能分层

#### 匿名用户可用（无需登录）

| 功能 | 说明 | 限制 |
|------|------|------|
| AI简历优化 | 混元大模型优化工作经历 | 24小时内3次免费 |
| AI示例生成 | 生成STAR法则参考示例 | 计入次数 |
| 复制结果 | 复制到剪贴板 | 无限制 |
| 优化风格选择 | 三种优化风格 | 无限制 |
| 看广告获取次数 | 观看激励视频广告 | 1次/广告，最多7次/24h |

#### 登录用户专属

| 功能 | 说明 | 价值 |
|------|------|------|
| 云端历史记录 | 查看最近30天的优化记录 | 跨设备查看 |
| 跨设备同步 | 多设备数据同步 | 便捷访问 |
| 用户中心 | 个人信息管理 | 专属体验 |
| 数据持久化 | 长期保存数据 | 不会丢失 |

---

### 用户状态转换

```
匿名用户（implicit）
    ↓ (次数用完时引导)
登录用户（registered）
    ↓ (解锁高级功能)
```

---

### 关键设计决策（已确认）

| 决策点 | 你的选择 | 说明 |
|--------|---------|------|
| **重置机制** | 24小时滚动重置 | 从第一次使用开始计算，用户体验更好 |
| **广告奖励** | 1次/广告 | 防止刷广告，平衡用户体验和收益 |
| **匿名历史** | 不保存 | 简化实现，历史记录作为登录专属功能 |
| **登录触发** | 次数用完时引导 | 不打扰用户，渐进式登录 |

---

## 用户系统功能清单

### P0：核心功能（必须实现）

#### 1. 静默获取OpenID

**描述**：用户首次打开小程序时，静默获取OpenID作为匿名用户标识

**实现方式**：
- 云函数：复用现有 `login` 云函数
- 前端：`app.js` 中 `onLaunch` 时调用
- 缓存：存储到本地，避免重复调用

**代码位置**：
- 前端：`app.js`
- 云函数：`cloudfunctions/login/index.js`（已存在）

**工作量**：0.5天

---

#### 2. 次数控制系统

**描述**：控制用户在24小时内的使用次数，3次免费，看广告获取额外机会，最多10次

**实现逻辑**：
- 检查：每次调用AI功能前检查剩余次数
- 扣减：使用成功后扣减对应次数
- 重置：24小时后自动重置（从第一次使用开始计算）
- 类型：区分 `free`（免费）和 `ad`（广告获得）

**关键数据**：
```javascript
{
  freeRemaining: 3,      // 剩余免费次数
  adRemaining: 0,        // 广告获得次数
  totalUsed: 0,          // 24小时内已使用次数
  firstUseTime: Date      // 第一次使用时间（用于24小时重置）
}
```

**适用云函数**：
- `optimizeResume`（AI优化）
- `generateExample`（示例生成）

**工作量**：1.5天

---

#### 3. 激励视频广告集成

**描述**：用户免费次数用完后，可观看激励视频广告获取额外使用次数

**广告逻辑**：
- 触发条件：免费次数用完，且未达10次上限
- 奖励：看完广告获得1次使用机会
- 限制：24小时内最多7次广告（保证总次数不超过10次）

**广告组件**：`wx.createRewardedVideoAd()`

**关键事件处理**：
- `onLoad`：广告加载成功
- `onError`：广告加载失败（错误码处理）
- `onClose`：广告关闭（判断 `isEnded`，只有看完才给奖励）

**工作量**：1.5天

---

#### 4. 用户配额云函数

**描述**：统一管理用户配额检查、扣减、重置的云函数

**云函数名称**：`checkQuota`

**主要功能**：
1. 检查剩余次数
2. 扣减对应次数（免费/广告）
3. 24小时重置检查
4. 统计使用日志

**API设计**：
```javascript
// 检查配额
wx.cloud.callFunction({
  name: 'checkQuota',
  data: { action: 'check' }
})
// 返回：{ canUse: boolean, type: 'free'|'ad'|'limit', remaining: number }

// 扣减配额
wx.cloud.callFunction({
  name: 'checkQuota',
  data: { action: 'consume', type: 'free' }
})
// 返回：{ success: boolean, remaining: number }
```

**工作量**：1天

---

### P1：高级功能（短期规划）

#### 5. 云端历史记录

**描述**：登录用户可以查看最近30天的优化历史

**功能特性**：
- 查询：按时间倒序，显示最近30天
- 详情：点击查看原文、优化结果、优化风格
- 恢复：一键恢复到输入框
- 删除：删除单条记录
- 清空：清空所有历史记录

**数据结构**：
```javascript
{
  _openid: String,
  originalContent: String,
  optimizedContent: String,
  style: String,           // data/leadership/concise
  styleName: String,
  modelName: String,       // hunyuan-turbos-latest
  createTime: Date,
  updateTime: Date
}
```

**数据库集合**：`history_records`

**工作量**：2天

---

#### 6. 登录功能

**描述**：用户主动点击登录，获取头像、昵称，升级为注册用户

**登录方式**：微信授权（头像、昵称）

**登录流程**：
1. 用户点击"登录"按钮
2. 调用 `wx.getUserProfile()` 获取头像、昵称
3. 更新 `users` 表中的 `userType` 为 `registered`
4. 保存 `userInfo` 到本地存储
5. 跳转到历史记录页面

**触发时机**：
- 次数用完时引导
- 用户主动点击"历史记录"时
- 用户主动点击"用户中心"时

**工作量**：1天

---

#### 7. 用户中心页面

**描述**：展示用户信息、使用统计、设置选项

**页面内容**：
- 用户头像、昵称（登录后显示）
- 今日使用统计（已用次数/剩余次数）
- 累计使用次数
- 设置：默认优化风格
- 关于：版本信息、联系方式
- 退出登录按钮

**页面路由**：`/pages/usercenter/usercenter`

**工作量**：1.5天

---

#### 8. 次数显示优化

**描述**：在首页显示用户剩余次数，提升透明度

**显示位置**：首页操作区下方

**显示内容**：
- 匿名用户："今日可用：3次"
- 免费次数用完："免费次数已用完，看广告获取"
- 达到上限："今日次数已达上限，明天再试"

**交互逻辑**：
- 点击次数提示 → 如果免费次数用完，显示广告按钮
- 实时更新：每次使用后更新显示

**工作量**：0.5天

---

### P2：体验优化（中期规划）

#### 9. 历史记录列表优化

**描述**：优化历史记录列表的展示和交互

**优化点**：
- 瀑布流布局（卡片式）
- 搜索/筛选功能（按日期、按风格）
- 加载更多（分页）
- 长按操作（快捷删除、复制）

**工作量**：1天

---

#### 10. 数据统计功能

**描述**：在用户中心显示详细的使用统计

**统计维度**：
- 今日使用次数
- 累计使用次数
- 累计观看广告次数
- 最常使用的优化风格
- 本周/本月使用趋势（图表）

**工作量**：1.5天

---

#### 11. 优化前后对比

**描述**：显示原文和优化结果的对比，高亮差异

**对比方式**：
- 并排显示：原文 | 优化结果
- 差异高亮：删除线（删除）、绿色（新增）
- 字数统计：原文X字 → 优化后Y字（±Z字）

**工作量**：2天

---

#### 12. 多段工作经历处理

**描述**：支持同时优化多段工作经历

**功能特性**：
- 卡片式布局，支持添加/删除多个工作经历
- 每段独立选择优化风格
- 逐个优化或批量优化
- 拖拽排序
- 限制最多10段

**工作量**：3天

---

#### 13. 导出功能

**描述**：导出优化结果为多种格式

**支持格式**：
- PDF
- Word (.docx)
- 长图

**工作量**：2.5天

---

#### 14. 撤销/重做功能

**描述**：优化后可以撤销到上一步

**实现方式**：
- 栈结构（最大10步）
- 快捷键：Ctrl+Z（撤销）、Ctrl+Y（重做）
- UI按钮：显示可撤销/重做次数

**工作量**：1天

---

### P3：长期规划

#### 15. 用户分享

**描述**：用户可以分享优化结果到微信好友/群

**分享内容**：
- 优化后文本
- 长图
- 小程序卡片

**工作量**：1天

---

#### 16. 反馈功能

**描述**：用户可以提交使用反馈和建议

**实现方式**：
- 表单提交
- 图片上传
- 云函数接收并存储

**工作量**：1天

---

#### 17. 夜间模式

**描述**：支持深色主题切换

**实现方式**：
- 适配系统主题（跟随系统）
- 手动切换（设置中）
- 渐变背景适配

**工作量**：1天

---

## 技术实现方案

### 1. 匿名用户ID管理

#### 方案：静默获取OpenID（复用现有login云函数）

**前端实现**（`app.js`）：
```javascript
App({
  globalData: {
    openid: null,
    userType: 'implicit',  // implicit | registered
    userInfo: null
  },

  async onLaunch() {
    // 1. 检查本地缓存
    let openid = wx.getStorageSync('openid')
    let userInfo = wx.getStorageSync('userInfo')

    // 2. 如果没有openid，调用云函数获取
    if (!openid) {
      try {
        const res = await wx.cloud.callFunction({
          name: 'login'
        })
        openid = res.result.openid
        wx.setStorageSync('openid', openid)
      } catch (err) {
        console.error('获取OpenID失败:', err)
      }
    }

    // 3. 更新全局状态
    this.globalData.openid = openid
    this.globalData.userInfo = userInfo
    this.globalData.userType = userInfo ? 'registered' : 'implicit'

    // 4. 初始化每日使用统计
    this.initDailyUsage()
  },

  initDailyUsage() {
    const now = Date.now()
    const firstUseTime = wx.getStorageSync('first_use_time')

    if (!firstUseTime) {
      // 首次使用，记录时间
      wx.setStorageSync('first_use_time', now)
      wx.setStorageSync('usage_start_time', now)
    } else {
      // 检查是否超过24小时
      const elapsed = now - firstUseTime
      const hours24 = 24 * 60 * 60 * 1000

      if (elapsed >= hours24) {
        // 超过24小时，重置
        wx.setStorageSync('first_use_time', now)
        wx.setStorageSync('free_count', 3)
        wx.setStorageSync('ad_count', 0)
      }
    }

    // 确保有初始值
    if (!wx.getStorageSync('free_count')) {
      wx.setStorageSync('free_count', 3)
    }
    if (!wx.getStorageSync('ad_count')) {
      wx.setStorageSync('ad_count', 0)
    }
  },

  // 检查登录状态
  checkLogin() {
    return this.globalData.userType === 'registered'
  },

  // 更新用户信息（登录后调用）
  updateUserInfo(userInfo) {
    this.globalData.userInfo = userInfo
    this.globalData.userType = 'registered'
    wx.setStorageSync('userInfo', userInfo)
  }
})
```

**云函数**（已存在 `cloudfunctions/login/index.js`）：
```javascript
// 无需修改，直接复用
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  return {
    event,
    openid: wxContext.OPENID,
    appid: wxContext.APPID,
    unionid: wxContext.UNIONID,
  }
}
```

---

### 2. 次数控制系统

#### 方案：本地存储 + 云函数验证

**工具函数**（`utils/usage.js`）：
```javascript
const MAX_FREE = 3
const MAX_TOTAL = 10

/**
 * 检查使用次数
 * @returns {Object} { canUse, type, remaining }
 */
function checkUsage() {
  const freeCount = wx.getStorageSync('free_count') || 0
  const adCount = wx.getStorageSync('ad_count') || 0

  if (freeCount > 0) {
    return {
      canUse: true,
      type: 'free',
      remaining: freeCount,
      message: `今日可用免费${freeCount}次`
    }
  }

  const totalUsed = freeCount + adCount
  const adMax = MAX_TOTAL - MAX_FREE

  if (adCount < adMax) {
    return {
      canUse: false,
      type: 'need_ad',
      remaining: MAX_TOTAL - totalUsed,
      message: '免费次数已用完，看广告获取'
    }
  }

  return {
    canUse: false,
    type: 'limit_reached',
    remaining: 0,
    message: '今日次数已达上限，明天再试'
  }
}

/**
 * 扣减使用次数
 * @param {String} type - 'free' | 'ad'
 * @returns {Boolean} 是否成功
 */
function consumeUsage(type = 'free') {
  if (type === 'free') {
    let count = wx.getStorageSync('free_count') || 0
    if (count > 0) {
      wx.setStorageSync('free_count', count - 1)
      return true
    }
  } else {
    let count = wx.getStorageSync('ad_count') || 0
    const adMax = MAX_TOTAL - MAX_FREE
    if (count < adMax) {
      wx.setStorageSync('ad_count', count + 1)
      return true
    }
  }
  return false
}

/**
 * 获取24小时剩余时间
 * @returns {String} 格式化的剩余时间
 */
function getRemainingTime() {
  const firstUseTime = wx.getStorageSync('first_use_time') || Date.now()
  const nextResetTime = firstUseTime + 24 * 60 * 60 * 1000
  const remaining = nextResetTime - Date.now()

  if (remaining <= 0) {
    return '即将重置'
  }

  const hours = Math.floor(remaining / (60 * 60 * 1000))
  const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000))

  return `${hours}小时${minutes}分钟后重置`
}

module.exports = {
  checkUsage,
  consumeUsage,
  getRemainingTime
}
```

**前端使用**（`pages/index/index.js`）：
```javascript
const { checkUsage, consumeUsage } = require('../../utils/usage')

Page({
  data: {
    usageInfo: null
  },

  onLoad() {
    this.updateUsageDisplay()
  },

  // 更新次数显示
  updateUsageDisplay() {
    const usage = checkUsage()
    this.setData({ usageInfo: usage })
  },

  // 开始AI优化
  async startOptimization() {
    // 1. 检查输入
    if (!this.data.workExperience.trim()) {
      wx.showToast({ title: '请输入工作经历描述', icon: 'none' })
      return
    }

    // 2. 检查使用次数
    const usage = checkUsage()

    if (!usage.canUse) {
      if (usage.type === 'need_ad') {
        // 免费次数用完，提示看广告
        await this.showAdPrompt()
      } else {
        // 达到上限，提示登录
        await this.showLoginPrompt()
      }
      return
    }

    // 3. 显示加载
    this.setData({ isOptimizing: true })

    try {
      // 4. 调用AI优化
      const res = await wx.cloud.callFunction({
        name: 'optimizeResume',
        data: {
          content: this.data.workExperience,
          style: this.data.selectedStyle
        },
        timeout: 60000
      })

      // 5. 优化成功，扣减次数
      consumeUsage('free')

      // 6. 更新UI
      this.setData({
        workExperience: res.result.data,
        isOptimizing: false
      })

      // 7. 更新次数显示
      this.updateUsageDisplay()

      wx.showToast({ title: '优化完成', icon: 'success' })

    } catch (err) {
      this.setData({ isOptimizing: false })
      wx.showToast({ title: '网络错误，请重试', icon: 'none' })
    }
  },

  // 提示看广告
  async showAdPrompt() {
    const res = await wx.showModal({
      title: '次数不足',
      content: '今日免费次数已用完，观看短视频可获取额外使用机会',
      confirmText: '观看广告',
      cancelText: '取消'
    })

    if (res.confirm) {
      await this.showRewardedAd()
    } else {
      // 引导登录
      await this.showLoginPrompt()
    }
  },

  // 提示登录
  async showLoginPrompt() {
    const app = getApp()

    if (app.checkLogin()) {
      // 已经登录，提示明天再试
      wx.showModal({
        title: '次数已用完',
        content: '今日次数已达上限，明天再试吧',
        showCancel: false
      })
      return
    }

    const res = await wx.showModal({
      title: '解锁更多次数',
      content: '登录会员可每日免费使用10次',
      confirmText: '去登录',
      cancelText: '取消'
    })

    if (res.confirm) {
      wx.navigateTo({ url: '/pages/login/login' })
    }
  },

  // 显示激励视频广告
  async showRewardedAd() {
    if (!this.rewardedVideoAd) {
      this.initAd()
    }

    try {
      this.rewardedVideoAd.show()
    } catch (err) {
      // 广告未加载，先加载
      this.rewardedVideoAd.load().then(() => {
        this.rewardedVideoAd.show()
      }).catch(() => {
        wx.showToast({ title: '广告加载失败', icon: 'none' })
      })
    }
  },

  // 初始化广告
  initAd() {
    this.rewardedVideoAd = wx.createRewardedVideoAd({
      adUnitId: 'adunit-xxxxx'  // 替换为你的广告单元ID
    })

    this.rewardedVideoAd.onLoad(() => {
      console.log('广告加载成功')
    })

    this.rewardedVideoAd.onError((err) => {
      console.error('广告错误:', err)
      if (err.errCode !== 1004) {  // 1004=无适合广告，属于正常
        wx.showToast({ title: '广告加载失败', icon: 'none' })
      }
    })

    this.rewardedVideoAd.onClose((res) => {
      if (res && res.isEnded) {
        // 看完广告，增加次数
        const success = consumeUsage('ad')
        if (success) {
          this.updateUsageDisplay()
          wx.showToast({ title: '获得额外1次', icon: 'success' })
        }
      } else {
        wx.showToast({ title: '未看完广告', icon: 'none' })
      }
    })
  }
})
```

---

### 3. 激励视频广告集成

#### 广告组件初始化

**位置**：`pages/index/index.js`

```javascript
Page({
  onLoad() {
    // 检查是否支持广告
    if (wx.createRewardedVideoAd) {
      this.initRewardedAd()
    }
  },

  onUnload() {
    // 销毁广告实例
    if (this.rewardedVideoAd) {
      this.rewardedVideoAd = null
    }
  },

  initRewardedAd() {
    // 创建广告实例
    this.rewardedVideoAd = wx.createRewardedVideoAd({
      adUnitId: 'adunit-xxxxx'  // 替换为你的广告单元ID
    })

    // 监听广告加载成功
    this.rewardedVideoAd.onLoad(() => {
      console.log('[AD] 广告加载成功')
      this.setData({ adLoaded: true })
    })

    // 监听广告加载错误
    this.rewardedVideoAd.onError((err) => {
      console.error('[AD] 广告加载失败:', err)

      // 根据错误码给出不同提示
      let message = '广告加载失败'
      switch (err.errCode) {
        case 1004:
          // 无适合广告，属于正常情况
          this.setData({ adAvailable: false })
          return
        case 1000:
        case 1003:
          message = '服务暂时不可用，请稍后再试'
          break
        case 1002:
          message = '广告配置错误，请联系客服'
          break
        case 1005:
          message = '广告审核中，暂不可用'
          break
        case 1006:
          message = '广告审核未通过'
          break
        case 1007:
          message = '广告功能已被禁用'
          break
        case 1008:
          message = '广告位已关闭'
          break
      }

      this.setData({ adLoaded: false })
      if (err.errCode !== 1004) {
        wx.showToast({ title: message, icon: 'none' })
      }
    })

    // 监听广告关闭
    this.rewardedVideoAd.onClose((res) => {
      if (res && res.isEnded) {
        // 用户看完广告，发放奖励
        this.onAdRewarded()
      } else {
        // 用户中途关闭
        wx.showToast({
          title: '需要完整观看广告才能获得奖励',
          icon: 'none'
        })
      }
    })
  },

  // 广告奖励回调
  async onAdRewarded() {
    try {
      // 调用云函数记录广告观看
      const res = await wx.cloud.callFunction({
        name: 'recordAdWatch'
      })

      if (res.result.code === 0) {
        // 更新本地次数
        const success = consumeUsage('ad')

        if (success) {
          this.updateUsageDisplay()

          wx.showToast({
            title: `获得额外1次，今日剩余${res.result.data.remaining}次`,
            icon: 'success',
            duration: 2000
          })
        }
      }
    } catch (err) {
      console.error('广告奖励失败:', err)
      wx.showToast({ title: '奖励发放失败', icon: 'none' })
    }
  }
})
```

---

### 4. 云端历史记录

#### 数据库集合设计

**集合名**：`history_records`

**索引**：
- `_openid` + `createTime`（查询用户历史）

---

#### 云函数：查询历史记录

**文件**：`cloudfunctions/getHistoryRecords/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()
const _ = db.command

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID
  const { limit = 20, offset = 0 } = event

  try {
    // 查询最近30天的历史记录
    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)

    const res = await db.collection('history_records')
      .where({
        _openid: openid,
        createTime: _.gte(thirtyDaysAgo)
      })
      .orderBy('createTime', 'desc')
      .skip(offset)
      .limit(limit)
      .get()

    // 查询总数
    const countRes = await db.collection('history_records')
      .where({
        _openid: openid,
        createTime: _.gte(thirtyDaysAgo)
      })
      .count()

    return {
      code: 0,
      data: {
        records: res.data,
        total: countRes.total,
        hasMore: offset + res.data.length < countRes.total
      }
    }
  } catch (err) {
    console.error('查询历史记录失败:', err)
    return {
      code: -1,
      message: err.message || '查询失败'
    }
  }
}
```

---

#### 云函数：保存历史记录

**文件**：`cloudfunctions/saveHistoryRecord/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID

  const {
    originalContent,
    optimizedContent,
    style,
    styleName
  } = event

  // 参数校验
  if (!originalContent || !optimizedContent) {
    return {
      code: -1,
      message: '内容不能为空'
    }
  }

  try {
    const now = new Date()

    const res = await db.collection('history_records').add({
      data: {
        _openid: openid,
        originalContent,
        optimizedContent,
        style,
        styleName,
        modelName: 'hunyuan-turbos-latest',
        createTime: now,
        updateTime: now
      }
    })

    return {
      code: 0,
      data: {
        id: res._id,
        createTime: now
      }
    }
  } catch (err) {
    console.error('保存历史记录失败:', err)
    return {
      code: -1,
      message: err.message || '保存失败'
    }
  }
}
```

---

#### 前端历史记录页面

**文件**：`pages/history/history.js`

```javascript
const app = getApp()

Page({
  data: {
    records: [],
    loading: false,
    hasMore: true,
    offset: 0,
    limit: 20
  },

  onLoad() {
    // 检查登录状态
    if (!app.checkLogin()) {
      wx.showModal({
        title: '需要登录',
        content: '登录后可查看历史记录',
        confirmText: '去登录',
        success: (res) => {
          if (res.confirm) {
            wx.navigateTo({ url: '/pages/login/login' })
          } else {
            wx.navigateBack()
          }
        }
      })
      return
    }

    this.loadRecords()
  },

  // 加载历史记录
  async loadRecords() {
    if (this.data.loading || !this.data.hasMore) {
      return
    }

    this.setData({ loading: true })

    try {
      const res = await wx.cloud.callFunction({
        name: 'getHistoryRecords',
        data: {
          limit: this.data.limit,
          offset: this.data.offset
        }
      })

      if (res.result.code === 0) {
        this.setData({
          records: this.data.records.concat(res.result.data.records),
          hasMore: res.result.data.hasMore,
          offset: this.data.offset + res.result.data.records.length
        })
      }
    } catch (err) {
      console.error('加载历史记录失败:', err)
      wx.showToast({ title: '加载失败', icon: 'none' })
    } finally {
      this.setData({ loading: false })
    }
  },

  // 触底加载更多
  onReachBottom() {
    this.loadRecords()
  },

  // 下拉刷新
  onPullDownRefresh() {
    this.setData({
      records: [],
      offset: 0,
      hasMore: true
    })
    this.loadRecords()
    wx.stopPullDownRefresh()
  },

  // 查看详情
  viewDetail(e) {
    const id = e.currentTarget.dataset.id
    wx.navigateTo({
      url: `/pages/history-detail/history-detail?id=${id}`
    })
  },

  // 恢复到输入框
  resumeToInput(e) {
    const item = e.currentTarget.dataset.item
    const pages = getCurrentPages()
    const currentPage = pages[pages.length - 1]

    // 返回首页
    wx.navigateBack()

    // 通知首页更新内容
    setTimeout(() => {
      const indexPage = pages[pages.length - 2]
      if (indexPage && indexPage.setData) {
        indexPage.setData({
          workExperience: item.optimizedContent
        })
      }
    }, 100)
  },

  // 删除记录
  async deleteRecord(e) {
    const id = e.currentTarget.dataset.id
    const res = await wx.showModal({
      title: '确认删除',
      content: '确定要删除这条记录吗？'
    })

    if (res.confirm) {
      try {
        await wx.cloud.callFunction({
          name: 'deleteHistoryRecord',
          data: { id }
        })

        // 从列表中移除
        const records = this.data.records.filter(item => item._id !== id)
        this.setData({ records })

        wx.showToast({ title: '已删除', icon: 'success' })
      } catch (err) {
        console.error('删除失败:', err)
        wx.showToast({ title: '删除失败', icon: 'none' })
      }
    }
  },

  // 清空所有
  async clearAll() {
    const res = await wx.showModal({
      title: '确认清空',
      content: '确定要清空所有历史记录吗？'
    })

    if (res.confirm) {
      try {
        await wx.cloud.callFunction({
          name: 'clearHistoryRecords'
        })

        this.setData({
          records: [],
          offset: 0,
          hasMore: false
        })

        wx.showToast({ title: '已清空', icon: 'success' })
      } catch (err) {
        console.error('清空失败:', err)
        wx.showToast({ title: '清空失败', icon: 'none' })
      }
    }
  }
})
```

---

### 5. 登录功能

#### 登录页面

**文件**：`pages/login/login.js`

```javascript
const app = getApp()

Page({
  data: {
    loading: false
  },

  // 微信授权登录
  async handleLogin() {
    if (this.data.loading) return

    this.setData({ loading: true })

    try {
      // 获取用户信息
      const userProfile = await wx.getUserProfile({
        desc: '用于完善用户资料'
      })

      const userInfo = {
        nickName: userProfile.userInfo.nickName,
        avatarUrl: userProfile.userInfo.avatarUrl,
        gender: userProfile.userInfo.gender,
        language: userProfile.userInfo.language
      }

      // 调用云函数保存用户信息
      const res = await wx.cloud.callFunction({
        name: 'updateUserInfo',
        data: { userInfo }
      })

      if (res.result.code === 0) {
        // 更新全局状态
        app.updateUserInfo(userInfo)

        wx.showToast({
          title: '登录成功',
          icon: 'success',
          duration: 1500
        })

        // 延迟跳转
        setTimeout(() => {
          wx.switchTab({
            url: '/pages/index/index'
          })
        }, 1500)
      } else {
        wx.showToast({
          title: res.result.message || '登录失败',
          icon: 'none'
        })
      }
    } catch (err) {
      console.error('登录失败:', err)

      if (err.errMsg && err.errMsg.includes('getUserProfile:fail')) {
        wx.showToast({
          title: '已取消授权',
          icon: 'none'
        })
      } else {
        wx.showToast({
          title: '登录失败，请重试',
          icon: 'none'
        })
      }
    } finally {
      this.setData({ loading: false })
    }
  },

  // 返回首页
  goBack() {
    wx.navigateBack()
  }
})
```

---

#### 云函数：更新用户信息

**文件**：`cloudfunctions/updateUserInfo/index.js`

```javascript
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })

const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID

  const { userInfo } = event

  if (!userInfo) {
    return {
      code: -1,
      message: '用户信息不能为空'
    }
  }

  try {
    // 查询用户记录
    const userRes = await db.collection('users')
      .where({ _openid: openid })
      .get()

    if (userRes.data.length === 0) {
      // 创建新用户
      await db.collection('users').add({
        data: {
          _openid: openid,
          userType: 'registered',
          userInfo: userInfo,
          createTime: new Date(),
          updateTime: new Date()
        }
      })
    } else {
      // 更新现有用户
      await db.collection('users')
        .doc(userRes.data[0]._id)
        .update({
          data: {
            userType: 'registered',
            userInfo: userInfo,
            updateTime: new Date()
          }
        })
    }

    return {
      code: 0,
      message: '登录成功'
    }
  } catch (err) {
    console.error('更新用户信息失败:', err)
    return {
      code: -1,
      message: err.message || '登录失败'
    }
  }
}
```

---

## 数据库设计

### users（用户表）

**用途**：存储用户基本信息和配额

```javascript
{
  _id: String,
  _openid: String,               // 用户openid（自动）

  // 用户类型
  userType: String,              // implicit | registered

  // 用户信息（登录后才有）
  userInfo: {
    nickName: String,
    avatarUrl: String,
    gender: Number,              // 0:未知 1:男 2:女
    language: String
  },

  // 配额信息（24小时制）
  quota: {
    freeRemaining: Number,       // 剩余免费次数（默认3）
    adRemaining: Number,         // 广告获得次数（默认0）
    totalUsed: Number,           // 24小时内已使用次数
    firstUseTime: Date,         // 第一次使用时间（用于24小时重置）
    lastUseTime: Date           // 最后使用时间
  },

  // 统计信息
  stats: {
    totalOptimizeCount: Number,     // 累计优化次数
    totalAdWatchCount: Number,      // 累计观看广告次数
    registerTime: Date,            // 注册时间
    lastLoginTime: Date            // 最后登录时间
  },

  createTime: Date,
  updateTime: Date
}
```

**索引**：
- `_openid`（唯一索引）
- `quota.firstUseTime`（用于24小时重置检查）

---

### usage_logs（使用日志表）

**用途**：记录每次使用，用于统计和审计

```javascript
{
  _id: String,
  _openid: String,
  action: String,              // optimize | generateExample
  type: String,                // free | ad

  // 详细信息
  style: String,               // data/leadership/concise
  contentLength: Number,       // 内容长度
  modelName: String,           // 模型名称

  // 时间
  createTime: Date
}
```

**索引**：
- `_openid` + `createTime`（查询用户使用记录）
- `createTime`（全局统计）

---

### history_records（历史记录表）

**用途**：存储用户的优化历史记录（登录用户）

```javascript
{
  _id: String,
  _openid: String,

  // 内容
  originalContent: String,      // 原始内容
  optimizedContent: String,     // 优化后内容

  // 配置
  style: String,               // 优化风格：data/leadership/concise
  styleName: String,           // 优化风格名称
  modelName: String,           // 模型名称

  // 元数据
  contentLength: Number,       // 原始内容长度
  optimizedLength: Number,     // 优化后内容长度
  improvementRate: Number,     // 优化幅度（百分比）

  createTime: Date,
  updateTime: Date
}
```

**索引**：
- `_openid` + `createTime`（查询用户历史记录，降序）
- `createTime`（用于30天过期清理）

---

### ad_logs（广告日志表）

**用途**：记录广告观看情况，防止刷广告

```javascript
{
  _id: String,
  _openid: String,

  // 广告信息
  adUnitId: String,           // 广告单元ID
  adType: String,            // 广告类型：rewarded_video

  // 结果
  isEnded: Boolean,          // 是否看完广告
  rewardAmount: Number,      // 奖励次数

  // 时间
  startTime: Date,
  endTime: Date,
  createTime: Date
}
```

**索引**：
- `_openid` + `createTime`（查询用户广告观看记录）
- `createTime`（防刷检查）

---

### 数据库安全规则

```javascript
// users 集合
{
  "read": "doc._openid == auth.openid || doc._openid == null",
  "write": "doc._openid == auth.openid || doc._openid == null"
}

// usage_logs 集合
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid || 'cloud' == auth.openid"
}

// history_records 集合
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}

// ad_logs 集合
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid || 'cloud' == auth.openid"
}
```

---

## 开发排期计划

### 第一阶段：商业化基础（5-6天）🎯

**目标**：实现完整的商业化闭环，支持匿名使用和渐进式登录

| 天数 | 任务 | 工作量 | 产出 | 优先级 |
|------|------|--------|------|--------|
| Day 1 | 静默获取OpenID + 数据库设计 | 1天 | 用户ID、4个数据表 | P0 |
| Day 2 | 次数控制系统（24小时滚动） | 1.5天 | 本地存储、检查逻辑 | P0 |
| Day 3 | 激励视频广告集成 | 1.5天 | 广告组件、奖励逻辑 | P0 |
| Day 4 | 用户配额云函数 | 1天 | checkQuota云函数 | P0 |
| Day 5 | 次数显示 + UI优化 | 0.5天 | 首页次数显示 | P0 |
| Day 6 | 测试和Bug修复 | 1天 | 稳定版本 | P0 |

**里程碑**：
- ✅ 用户可以匿名使用AI功能
- ✅ 24小时内免费3次
- ✅ 免费次数用完可看广告获取1次
- ✅ 最多10次/24小时
- ✅ 24小时后自动重置

---

### 第二阶段：高级功能（5天）🚀

**目标**：完善用户体验，添加历史记录和登录功能

| 天数 | 任务 | 工作量 | 产出 | 优先级 |
|------|------|--------|------|--------|
| Day 1-2 | 云端历史记录 | 2天 | getHistoryRecords、saveHistoryRecord云函数 | P1 |
| Day 3 | 登录功能 | 1天 | 登录页面、updateUserInfo云函数 | P1 |
| Day 4 | 用户中心页面 | 1.5天 | 用户信息、使用统计 | P1 |
| Day 5 | 测试和优化 | 0.5天 | 稳定版本 | P1 |

**里程碑**：
- ✅ 登录用户可查看历史记录
- ✅ 历史记录保存30天
- ✅ 用户中心展示个人信息和统计
- ✅ 支持退出登录

---

### 第三阶段：体验升级（3-5天）✨

**目标**：优化用户体验，添加辅助功能

| 任务 | 工作量 | 优先级 |
|------|--------|--------|
| 历史记录列表优化 | 1天 | P2 |
| 数据统计功能 | 1.5天 | P2 |
| 优化前后对比 | 2天 | P2 |
| 多段工作经历处理 | 3天 | P1（高价值） |

---

### 第四阶段：功能完善（2-3天）🎨

**目标**：完善产品功能

| 任务 | 工作量 | 优先级 |
|------|--------|--------|
| 导出功能（PDF/Word/长图） | 2.5天 | P2 |
| 撤销/重做功能 | 1天 | P2 |
| 分享功能 | 1天 | P3 |
| 反馈功能 | 1天 | P3 |
| 夜间模式 | 1天 | P3 |

---

## 关键注意事项

### 1. 24小时滚动重置实现

**挑战**：比自然日重置复杂，需要记录首次使用时间

**解决方案**：
```javascript
// 本地存储首次使用时间
const firstUseTime = wx.getStorageSync('first_use_time') || Date.now()

// 计算下次重置时间
const nextResetTime = firstUseTime + 24 * 60 * 60 * 1000

// 检查是否需要重置
if (Date.now() >= nextResetTime) {
  // 重置次数
  wx.setStorageSync('first_use_time', Date.now())
  wx.setStorageSync('free_count', 3)
  wx.setStorageSync('ad_count', 0)
}
```

**注意事项**：
- 用户修改手机系统时间可能绕过限制（微信小程序会校验时间）
- 建议在云函数中也记录使用时间，防止篡改

---

### 2. 防刷广告机制

**挑战**：防止用户恶意刷广告获取次数

**解决方案**：
1. **时间限制**：同一条广告间隔至少10秒
2. **次数限制**：24小时内最多7次广告
3. **云端验证**：云函数记录广告观看时间，拒绝异常请求
4. **设备限制**：基于openid限制，无法彻底解决但可增加成本

**云函数验证**：
```javascript
// recordAdWatch 云函数
exports.main = async (event, context) => {
  const openid = cloud.getWXContext().OPENID
  const now = new Date()

  // 查询最近10秒内的广告观看记录
  const recentAds = await db.collection('ad_logs')
    .where({
      _openid: openid,
      createTime: _.gte(new Date(now - 10 * 1000))
    })
    .count()

  if (recentAds.total > 0) {
    return { code: -1, message: '请勿频繁观看广告' }
  }

  // 记录此次广告观看
  await db.collection('ad_logs').add({
    data: { _openid: openid, adType: 'rewarded_video', createTime: now }
  })

  return { code: 0 }
}
```

---

### 3. OpenID失效处理

**挑战**：极少数情况下，用户的OpenID可能会变化

**解决方案**：
1. 每次云函数调用时验证OpenID有效性
2. 如果检测到OpenID变化，自动创建新用户记录
3. 用户数据丢失无法避免，但可以提示用户

**云函数验证**：
```javascript
exports.main = async (event, context) => {
  const openid = cloud.getWXContext().OPENID

  // 查询用户记录
  const user = await db.collection('users')
    .where({ _openid: openid })
    .get()

  if (user.data.length === 0) {
    // OpenID变化或新用户，创建记录
    await db.collection('users').add({
      data: {
        _openid: openid,
        userType: 'implicit',
        quota: { freeRemaining: 3, totalUsed: 0 },
        createTime: new Date()
      }
    })
  }

  // 继续原有逻辑...
}
```

---

### 4. 匿名用户数据隔离

**挑战**：匿名用户和登录用户的数据如何隔离

**解决方案**：
- 匿名用户：只使用本地存储（`free_count`, `ad_count`）
- 登录用户：所有数据存储到云端（`users` 表）
- 登录时：本地数据清空，完全使用云端数据

**前端逻辑**：
```javascript
const app = getApp()

Page({
  async onLoad() {
    if (app.checkLogin()) {
      // 登录用户：从云端加载
      this.loadFromCloud()
    } else {
      // 匿名用户：从本地加载
      this.loadFromLocal()
    }
  }
})
```

---

### 5. 广告加载失败处理

**挑战**：广告加载失败时如何降级

**解决方案**：
1. 错误码1004（无适合广告）：隐藏广告按钮，提示登录
2. 其他错误：显示重试按钮，稍后再试
3. 网络错误：提示检查网络

**错误码参考**：
| 错误码 | 含义 | 处理方式 |
|--------|------|---------|
| 1000 | 后端错误 | 提示稍后重试 |
| 1001 | 参数错误 | 检查代码 |
| 1002 | 广告单元无效 | 检查adUnitId |
| 1003 | 内部错误 | 提示稍后重试 |
| 1004 | 无适合广告 | 隐藏广告按钮 |
| 1005 | 广告审核中 | 提示稍后再试 |
| 1006 | 广告驳回 | 提示无法使用 |
| 1007 | 广告封禁 | 提示无法使用 |
| 1008 | 广告单元关闭 | 检查广告位配置 |

---

### 6. 性能优化

**优化点**：
1. **减少云函数调用**：OpenID缓存到本地
2. **批量操作**：历史记录查询使用分页
3. **索引优化**：所有查询字段建立索引
4. **缓存策略**：频繁访问的数据缓存到本地
5. **图片优化**：用户头像使用CDN

---

### 7. 用户体验优化

**优化点**：
1. **无感登录**：静默获取OpenID，不打扰用户
2. **渐进式引导**：只在需要时引导登录
3. **清晰提示**：次数显示、剩余时间、错误提示
4. **流畅动画**：加载、切换、交互动画
5. **快速响应**：本地缓存、预加载

---

## 总结

### 设计原则总结

✅ **支持匿名使用**：用户可以不登录使用核心功能
✅ **渐进式登录**：只在需要时引导登录
✅ **24小时滚动重置**：用户体验更好
✅ **1次/广告奖励**：平衡用户体验和收益
✅ **匿名不保存历史**：简化实现，历史记录作为登录专属功能

### 开发排期总结

- **第一阶段（商业化基础）**：5-6天
- **第二阶段（高级功能）**：5天
- **第三阶段（体验升级）**：3-5天
- **第四阶段（功能完善）**：2-3天

**总计：15-19天完成完整商业化用户系统**

### 预期效果

完成第一和第二阶段后：
- ✅ 商业化闭环完成
- ✅ 支持匿名使用和渐进式登录
- ✅ 云端历史记录功能完整
- ✅ 用户体验大幅提升

完成所有阶段后：
- ✅ 功能完整的简历优化工具
- ✅ 可商业化运营
- ✅ 有稳定的广告收益
- ✅ 可扩展为完整简历生成平台

---

**文档维护者**：AI Assistant
**最后更新**：2026年2月6日
